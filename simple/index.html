<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub page as PWA template</title>
  <link rel="canonical" href="https://jackson-cmd.github.io/simple/" />
  <link rel="manifest" href="/simple/manifest.json">
</head>

<body>
  <button id="find-me">Show my location</button><br />
  <p id="status"></p>
  <a id="map-link" target="_blank"></a>

  <br>
  <button id="showNotificationBtn">Show Notification</button>
  …
  <p><button id="btnStart">START RECORDING</button><br />
    <button id="btnStop">STOP RECORDING</button>
  </p>

  <video controls></video>

  <video id="vid2" controls></video>
  <script>
    if (navigator.serviceWorker) {
      navigator.serviceWorker.register(
        '/simple/sw.js',
        { scope: '/simple/' }
      )
    }
    // Check if the browser supports the Notification API
    if ("Notification" in window) {
      // Check if notifications are allowed
      if (Notification.permission === "granted") {
        // If permission is already granted, you can show a notification
        showNotification();
      } else if (Notification.permission !== "denied") {
        // If permission is not denied, request permission
        document.getElementById("showNotificationBtn").addEventListener("click", function () {
          Notification.requestPermission().then(function (permission) {
            if (permission === "granted") {
              showNotification();
            }
          });
        });
      }
    }

    function showNotification() {
      // Create and display a notification
      const notification = new Notification("Hello, World!", {
        body: "This is a notification example.",
        icon: "https://via.placeholder.com/48", // Replace with your own icon URL
      });

      // Handle click on the notification
      notification.addEventListener("click", function () {
        alert("Notification clicked!");
      });
    }
    /* global Peer */

    /**
     * Gets the local audio stream of the current caller
     * @param callbacks - an object to set the success/error behavior
     * @returns {void}
     */

    let constraintObj = {
      audio: false,
      video: {
        facingMode: "user",
        width: { min: 640, ideal: 1280, max: 1920 },
        height: { min: 480, ideal: 720, max: 1080 }
      }
    };
    // width: 1280, height: 720  -- preference only
    // facingMode: {exact: "user"}
    // facingMode: "environment"

    //handle older browsers that might implement getUserMedia in some way
    if (navigator.mediaDevices === undefined) {
      navigator.mediaDevices = {};
      navigator.mediaDevices.getUserMedia = function (constraintObj) {
        let getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
        if (!getUserMedia) {
          return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
        }
        return new Promise(function (resolve, reject) {
          getUserMedia.call(navigator, constraintObj, resolve, reject);
        });
      }
    } else {
      navigator.mediaDevices.enumerateDevices()
        .then(devices => {
          devices.forEach(device => {
            console.log(device.kind.toUpperCase(), device.label);
            //, device.deviceId
          })
        })
        .catch(err => {
          console.log(err.name, err.message);
        })
    }

    navigator.mediaDevices.getUserMedia(constraintObj)
      .then(function (mediaStreamObj) {
        //connect the media stream to the first video element
        let video = document.querySelector('video');
        if ("srcObject" in video) {
          video.srcObject = mediaStreamObj;
        } else {
          //old version
          video.src = window.URL.createObjectURL(mediaStreamObj);
        }

        video.onloadedmetadata = function (ev) {
          //show in the video element what is being captured by the webcam
          video.play();
        };

        //add listeners for saving video/audio
        let start = document.getElementById('btnStart');
        let stop = document.getElementById('btnStop');
        let vidSave = document.getElementById('vid2');
        let mediaRecorder = new MediaRecorder(mediaStreamObj);
        let chunks = [];

        start.addEventListener('click', (ev) => {
          mediaRecorder.start();
          console.log(mediaRecorder.state);
        })
        stop.addEventListener('click', (ev) => {
          mediaRecorder.stop();
          console.log(mediaRecorder.state);
        });
        mediaRecorder.ondataavailable = function (ev) {
          chunks.push(ev.data);
        }
        mediaRecorder.onstop = (ev) => {
          let blob = new Blob(chunks, { 'type': 'video/mp4;' });
          chunks = [];
          let videoURL = window.URL.createObjectURL(blob);
          vidSave.src = videoURL;
        }
      })
      .catch(function (err) {
        console.log(err.name, err.message);
      });

    // get geolocation
    function geoFindMe() {
      const status = document.querySelector("#status");
      const mapLink = document.querySelector("#map-link");

      mapLink.href = "";
      mapLink.textContent = "";

      function success(position) {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;

        status.textContent = "";
        mapLink.href = `https://www.openstreetmap.org/#map=18/${latitude}/${longitude}`;
        mapLink.textContent = `Latitude: ${latitude} °, Longitude: ${longitude} °`;
      }

      function error() {
        status.textContent = "Unable to retrieve your location";
      }

      if (!navigator.geolocation) {
        status.textContent = "Geolocation is not supported by your browser";
      } else {
        status.textContent = "Locating…";
        navigator.geolocation.getCurrentPosition(success, error);
      }
    }

    document.querySelector("#find-me").addEventListener("click", geoFindMe);


  </script>
</body>

</html>